<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevOps Demo - Nginx Load Balancer</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .info-box h3 {
            color: #1976d2;
            margin-bottom: 5px;
        }
        
        .info-box p {
            color: #555;
            font-size: 0.9em;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        button:active {
            transform: translateY(0);
        }

        button.clear-btn {
            background: #dc3545;
        }
        
        .response-box {
            background: #2d2d2d;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            min-height: 150px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            border: 1px solid #444;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: scale(1.05);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ DevOps Real: Nginx & Docker</h1>
        <p class="subtitle">Interagindo com Backend Cluster via Reverse Proxy</p>
        
        <div class="info-box">
            <h3>‚ÑπÔ∏è Arquitetura Ativa</h3>
            <p>
                Ao clicar no bot√£o, o Frontend chama <strong>/api/</strong>. 
                O Nginx intercepta e distribui a carga para um dos 3 containers Node.js usando o algoritmo <em>Least Connections</em>.
            </p>
        </div>
        
        <div>
            <button onclick="makeRequest()">üì° Requisitar API</button>
            <button onclick="makeMultipleRequests(10)">üîÑ 10 Requisi√ß√µes R√°pido</button>
            <button class="clear-btn" onclick="clearStats()">üóëÔ∏è Resetar Stats</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: #666;">Aguardando Nginx distribuir...</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalRequests">0</div>
                <div class="stat-label">Total Requests</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="backend1Count">0</div>
                <div class="stat-label">Backend 1</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="backend2Count">0</div>
                <div class="stat-label">Backend 2</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="backend3Count">0</div>
                <div class="stat-label">Backend 3</div>
            </div>
        </div>

        <div class="response-box" id="responseBox">// O log da resposta do servidor aparecer√° aqui...
 Aguardando intera√ß√£o.</div>
    </div>

    <script>
        // Estado da aplica√ß√£o
        let stats = { total: 0, backend1: 0, backend2: 0, backend3: 0 };
        const loading = document.getElementById('loading');
        const responseBox = document.getElementById('responseBox');

        async function makeRequest(isBatch = false) {
            if(!isBatch) loading.style.display = 'block';
            
            try {
                // AQUI ACONTECE A M√ÅGICA:
                // Chamamos /api/, o Nginx pega essa requisi√ß√£o e escolhe um backend.
                const res = await fetch('/api/');
                
                if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
                
                const data = await res.json();
                
                // Atualiza contadores baseado em QUEM respondeu
                stats.total++;
                
                if (data.server === 'Backend-1') stats.backend1++;
                else if (data.server === 'Backend-2') stats.backend2++;
                else if (data.server === 'Backend-3') stats.backend3++;
                else {
                    // Caso responda algo inesperado ou erro
                    console.warn("Servidor desconhecido:", data.server);
                }

                updateStats();

                // Mostra o JSON bonitinho na tela
                if(!isBatch) {
                    responseBox.textContent = `‚úÖ Resposta Recebida:\n` + 
                                              JSON.stringify(data, null, 2);
                }

            } catch (error) {
                console.error(error);
                responseBox.textContent = `‚ùå Erro de Conex√£o:\n\n` +
                                          `O Nginx ou os Backends parecem estar offline.\n` +
                                          `Verifique se rodou 'docker-compose up'.\n\n` +
                                          `Detalhe: ${error.message}`;
            } finally {
                if(!isBatch) loading.style.display = 'none';
            }
        }

        async function makeMultipleRequests(count) {
            loading.style.display = 'block';
            responseBox.textContent = `üöÄ Disparando ${count} requisi√ß√µes em paralelo...`;
            
            // Cria um array de promessas para disparar tudo "quase" junto
            // Isso for√ßa o Nginx a trabalhar mais duro no balanceamento
            const promises = [];
            for (let i = 0; i < count; i++) {
                promises.push(makeRequest(true));
                // Pequeno delay para n√£o travar o navegador visualmente
                await new Promise(r => setTimeout(r, 50)); 
            }
            
            await Promise.all(promises);
            
            loading.style.display = 'none';
            responseBox.textContent = `üèÅ Ciclo finalizado!\n\n` +
                                      `Observe a distribui√ß√£o da carga nos contadores acima.\n` +
                                      `O Nginx tentou equilibrar baseado em 'least_conn'.`;
        }

        function updateStats() {
            document.getElementById('totalRequests').textContent = stats.total;
            document.getElementById('backend1Count').textContent = stats.backend1;
            document.getElementById('backend2Count').textContent = stats.backend2;
            document.getElementById('backend3Count').textContent = stats.backend3;
        }

        function clearStats() {
            stats = { total: 0, backend1: 0, backend2: 0, backend3: 0 };
            updateStats();
            responseBox.textContent = "// Stats resetados. Pronto para novo teste.";
        }
    </script>
</body>
</html>